name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  CONTAINER_NAME: xam-api

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          REGISTRY: ghcr.io
          IMAGE_NAME: ${{ github.repository }}
          CONTAINER_NAME: xam-api
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          MINIO_ENDPOINT: ${{ secrets.MINIO_ENDPOINT }}
          MINIO_ACCESS_KEY: ${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY: ${{ secrets.MINIO_SECRET_KEY }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          envs: REGISTRY,IMAGE_NAME,CONTAINER_NAME,GITHUB_TOKEN,GITHUB_ACTOR,DATABASE_URL,JWT_SECRET,JWT_REFRESH_SECRET,MINIO_ENDPOINT,MINIO_ACCESS_KEY,MINIO_SECRET_KEY
          script: |
            set -e

            IMAGE="${REGISTRY}/${IMAGE_NAME}:latest"

            echo "=== Logging into GitHub Container Registry ==="
            echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin

            echo "=== Pulling new image ==="
            docker pull "$IMAGE"

            echo "=== Stopping old container ==="
            docker stop "$CONTAINER_NAME" 2>/dev/null || true
            docker rm "$CONTAINER_NAME" 2>/dev/null || true

            echo "=== Starting new container ==="
            docker run -d \
              --name "$CONTAINER_NAME" \
              --restart unless-stopped \
              --add-host=host.docker.internal:host-gateway \
              -p 3000:3000 \
              -e NODE_ENV=production \
              -e PORT=3000 \
              -e API_PREFIX=api \
              -e DATABASE_URL="$DATABASE_URL" \
              -e DATABASE_SSL=false \
              -e DATABASE_SYNCHRONIZE=false \
              -e DATABASE_LOGGING=false \
              -e JWT_SECRET="$JWT_SECRET" \
              -e JWT_EXPIRES_IN=15m \
              -e JWT_REFRESH_SECRET="$JWT_REFRESH_SECRET" \
              -e JWT_REFRESH_EXPIRES_IN=7d \
              -e MINIO_ENDPOINT="$MINIO_ENDPOINT" \
              -e MINIO_PORT=443 \
              -e MINIO_USE_SSL=true \
              -e MINIO_ACCESS_KEY="$MINIO_ACCESS_KEY" \
              -e MINIO_SECRET_KEY="$MINIO_SECRET_KEY" \
              -e MINIO_REGION=ap-southeast-1 \
              -e SWAGGER_ENABLED=true \
              -e THROTTLE_TTL=60 \
              -e THROTTLE_LIMIT=100 \
              -e SHUTDOWN_TIMEOUT=10000 \
              "$IMAGE"

            echo "=== Waiting for container to start ==="
            sleep 5

            echo "=== Container status ==="
            docker ps -f name="$CONTAINER_NAME"

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Wait for application startup
        run: sleep 10

      - name: Health check
        run: |
          MAX_RETRIES=12
          RETRY_INTERVAL=5

          echo "=== Checking application health ==="

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i of $MAX_RETRIES..."

            HEALTH_STATUS=$(curl -s https://api.getthean.com/api/health/live || echo "failed")

            if echo "$HEALTH_STATUS" | grep -q '"status":"ok"'; then
              echo "Health check passed!"
              echo "Response: $HEALTH_STATUS"
              exit 0
            fi

            echo "Health check failed, retrying in ${RETRY_INTERVAL}s..."
            sleep $RETRY_INTERVAL
          done

          echo "Health check failed after $MAX_RETRIES attempts"
          exit 1
